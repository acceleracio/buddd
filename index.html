<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Access with OTP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .login-form {
            margin-bottom: 20px;
        }
        input[type="email"], input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: none;
        }
        .access-denied {
            text-align: center;
            padding: 30px;
            background-color: #ffebee;
            border-radius: 8px;
            margin: 20px 0;
        }
        .access-denied h2 {
            color: #c62828;
            margin-bottom: 15px;
        }
        .access-denied p {
            color: #333;
            margin-bottom: 15px;
        }
        .get-otp-btn {
            background-color: #2196F3;
            margin-top: 10px;
        }
        .get-otp-btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Website Access Control</h1>
        <div class="login-form" id="loginForm">
            <h2>Enter your credentials to access the website</h2>
            <div>
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            <div>
                <label for="otp">OTP:</label>
                <input type="text" id="otp" placeholder="Enter your 6-digit OTP">
            </div>
            <button onclick="verifyOTP()">Submit</button>
            <div id="message" class="message"></div>
        </div>
        
        <div id="accessDeniedContainer" style="display:none" class="access-denied">
            <h2>Access Denied</h2>
            <p>The OTP you entered has already been used or is invalid.</p>
            <p>Please generate a new OTP to continue.</p>
            <button onclick="resetLoginForm()">Try Again</button>
        </div>
        
        <div id="iframeContainer">
            <iframe id="websiteFrame" src="" title="Embedded Website"></iframe>
        </div>
    </div>

    <script>
        // Target website URL - replace with your actual target website
        const TARGET_WEBSITE = "https://example.com";
        
        // Cloud storage connection details
        const CLOUD_API_URL = "https://api.cloudotpservice.com/v1";
        const CLOUD_API_KEY = "YOUR_API_KEY"; // Replace with your actual cloud API key
        
        // Check if already authenticated in this session
        window.onload = function() {
            checkAuthenticationStatus();
        };
        
        // Check if user is authenticated and show the appropriate view
        function checkAuthenticationStatus() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            const targetWebsite = sessionStorage.getItem('targetWebsite');
            
            if (isAuthenticated === 'true' && targetWebsite) {
                // User is already authenticated, show the iframe directly
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('accessDeniedContainer').style.display = 'none';
                document.getElementById('websiteFrame').src = targetWebsite;
                document.getElementById('websiteFrame').style.display = 'block';
                // Make iframe go fullscreen for better experience
                makeFullScreen();
            }
        }
        
        // Function to make the iframe go fullscreen
        function makeFullScreen() {
            const iframe = document.getElementById('websiteFrame');
            iframe.style.position = 'fixed';
            iframe.style.top = '0';
            iframe.style.left = '0';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.zIndex = '9999';
            iframe.style.border = 'none';
            
            // Hide everything else
            document.body.style.overflow = 'hidden';
            
            // Hide container
            document.querySelector('.container').style.boxShadow = 'none';
            document.querySelector('.container').style.maxWidth = '100%';
            document.querySelector('.container').style.padding = '0';
            document.querySelector('.container').style.margin = '0';
            document.querySelector('.container').style.borderRadius = '0';
            document.querySelector('.container').style.background = 'none';
        }
        
        // Validate email format
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Reset the login form for a new attempt
        function resetLoginForm() {
            document.getElementById('email').value = '';
            document.getElementById('otp').value = '';
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
            document.getElementById('accessDeniedContainer').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }
        
        // Cloud Storage Service to verify OTPs
        class CloudOTPService {
            constructor(apiUrl, apiKey) {
                this.apiUrl = apiUrl;
                this.apiKey = apiKey;
            }
            
            // Verify OTP against cloud storage
            async verifyOTP(email, otp) {
                console.log(`Verifying OTP for ${email}`);
                
                try {
                    // In a production environment, this would be a real API call
                    // For now, we'll simulate the network request
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            try {
                                // Simulate API call to cloud service
                                fetch(`${this.apiUrl}/otps/verify`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${this.apiKey}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ email, otp })
                                })
                                .then(response => {
                                    // Simulate response from cloud
                                    // For testing purposes, we need to check local storage
                                    // In production, this would come from your actual cloud service
                                    const storedOTPs = JSON.parse(localStorage.getItem('otps') || '{}');
                                    const usedOTPs = JSON.parse(localStorage.getItem('usedOTPs') || '[]');
                                    
                                    // Check if this combination is in the used OTPs list
                                    if (usedOTPs.includes(`${email}:${otp}`)) {
                                        resolve({ status: 'already_used' });
                                        return;
                                    }
                                    
                                    // Check if the OTP exists and matches
                                    if (storedOTPs[email] === otp) {
                                        // Mark this OTP as used
                                        usedOTPs.push(`${email}:${otp}`);
                                        localStorage.setItem('usedOTPs', JSON.stringify(usedOTPs));
                                        resolve({ status: 'valid' });
                                    } else {
                                        resolve({ status: 'invalid' });
                                    }
                                })
                                .catch(error => {
                                    console.error('Error verifying OTP:', error);
                                    reject(error);
                                });
                            } catch (error) {
                                console.error('Error in verifyOTP:', error);
                                reject(error);
                            }
                        }, 800); // Simulate network delay
                    });
                } catch (error) {
                    console.error('Error verifying OTP:', error);
                    throw error;
                }
            }
        }
        
        // Initialize cloud service
        const cloudService = new CloudOTPService(CLOUD_API_URL, CLOUD_API_KEY);
        
        async function verifyOTP() {
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp').value.trim();
            const messageDiv = document.getElementById('message');
            
            // Show loading state
            messageDiv.className = "message";
            messageDiv.textContent = "Verifying...";
            
            // Validate inputs
            if (!email || !otp) {
                messageDiv.className = "message error";
                messageDiv.textContent = "Please enter both email and OTP";
                return;
            }
            
            if (!isValidEmail(email)) {
                messageDiv.className = "message error";
                messageDiv.textContent = "Please enter a valid email address";
                return;
            }
            
            try {
                // Verify OTP with cloud service
                const result = await cloudService.verifyOTP(email, otp);
                
                switch (result.status) {
                    case 'valid':
                        // Success! Show the iframe
                        messageDiv.className = "message success";
                        messageDiv.textContent = "OTP verified successfully! Loading website...";
                        
                        // Save authentication state in session storage
                        sessionStorage.setItem('isAuthenticated', 'true');
                        sessionStorage.setItem('targetWebsite', TARGET_WEBSITE);
                        
                        // Load and show the iframe
                        setTimeout(() => {
                            document.getElementById('loginForm').style.display = 'none';
                            document.getElementById('accessDeniedContainer').style.display = 'none';
                            document.getElementById('websiteFrame').src ="https://acceleracio.github.io/buddd/";
                            document.getElementById('websiteFrame').style.display = 'block';
                            makeFullScreen();
                        }, 1000);
                        break;
                        
                    case 'already_used':
                        // Show the access denied screen
                        document.getElementById('loginForm').style.display = 'none';
                        document.getElementById('accessDeniedContainer').style.display = 'block';
                        break;
                        
                    case 'invalid':
                    default:
                        // Invalid OTP
                        messageDiv.className = "message error";
                        messageDiv.textContent = "Invalid OTP. Please try again with the correct OTP sent to your email.";
                        break;
                }
            } catch (error) {
                console.error("Error during verification:", error);
                messageDiv.className = "message error";
                messageDiv.textContent = "Verification failed. Please try again later.";
            }
        }
    </script>
</body>
</html>